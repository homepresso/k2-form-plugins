if (!window.__materialsplitbuttonRuntimeLoaded) {
  window.__materialsplitbuttonRuntimeLoaded = true;

/**
 * Material Split Button Control for K2 SmartForms
 * Material 3 Design split button with primary action and dropdown menu
 */
(function() {
  'use strict';

  if (typeof window.K2 === "undefined") {
    window.K2 = {};
  }

  function safeRaisePropertyChanged(ctrl, prop) {
    if (window.K2?.RaisePropertyChanged) {
      K2.RaisePropertyChanged(ctrl, prop);
    }
  }

  // Load Material Icons
  function loadMaterialIcons() {
    if (document.querySelector('link[href*="Material+Icons"]')) return;
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://fonts.googleapis.com/icon?family=Material+Icons';
    document.head.appendChild(link);
  }

  // Load Google Fonts
  function loadGoogleFonts() {
    if (document.querySelector('link[href*="fonts.googleapis.com/css2"]')) return;
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap';
    document.head.appendChild(link);
  }

  if (!window.customElements.get('material-split-button')) {
    const BaseClass = window.K2BaseControl || HTMLElement;
    window.customElements.define('material-split-button', class MaterialSplitButton extends BaseClass {

      constructor() {
        super();
        this._hasRendered = false;

        // Properties
        this._text = 'Save';
        this._selectedValue = '';
        this._ariaLabel = '';
        this._dropdownAriaLabel = '';
        this._leadingIcon = '';
        this._variant = 'filled'; // filled, outlined, tonal
        this._menuItems = 'Save as Draft|Save and Close|Save and New';
        this._delimiter = '|';
        this._primaryColor = '#6750A4';
        this._textColor = '';
        this._outlineColor = '#79747E';
        this._surfaceColor = '#FFFBFE';
        this._surfaceVariantColor = '#E7E0EC';
        this._menuBackgroundColor = '';
        this._menuTextColor = '#1C1B1F';
        this._dividerColor = '';
        this._disableRipple = false;
        this._fontFamily = 'Roboto, sans-serif';
        this._fontSize = 14;
        this._fontWeight = '500';
        this._fontStyle = 'normal';
        this._isVisible = true;
        this._isEnabled = true;
        this._isOpen = false;

        // Parsed menu items
        this._parsedItems = [];

        // DOM refs
        this._container = null;
        this._primaryBtn = null;
        this._dropdownBtn = null;
        this._menu = null;

        // Bound handlers
        this._handleClickOutside = this._handleClickOutside.bind(this);
        this._handleScroll = this._handleScroll.bind(this);
        this._handleResize = this._handleResize.bind(this);
      }

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();
        if (this._hasRendered) return;
        loadMaterialIcons();
        loadGoogleFonts();
        setTimeout(() => {
          this._parseMenuItems();
          this._render();
          this._hasRendered = true;
        }, 0);
      }

      disconnectedCallback() {
        document.removeEventListener('click', this._handleClickOutside);
        window.removeEventListener('scroll', this._handleScroll, true);
        window.removeEventListener('resize', this._handleResize);

        // Clean up portaled menu
        if (this._menu && this._menu.__portaled && this._menu.parentNode) {
          this._menu.parentNode.removeChild(this._menu);
        }
      }

      _parseMenuItems() {
        this._parsedItems = [];
        const delimiter = this._delimiter || '|';
        const items = this._menuItems ? this._menuItems.split(delimiter) : [];

        items.forEach(item => {
          const trimmed = item.trim();
          if (!trimmed) return;

          // Check for icon:label format
          const colonIndex = trimmed.indexOf(':');
          if (colonIndex > 0) {
            this._parsedItems.push({
              icon: trimmed.substring(0, colonIndex).trim(),
              label: trimmed.substring(colonIndex + 1).trim()
            });
          } else {
            this._parsedItems.push({
              icon: '',
              label: trimmed
            });
          }
        });
      }

      _render() {
        this.innerHTML = '';
        this._buildButton();
        this._applyStyles();
        this._bindEvents();
      }

      _buildButton() {
        this._container = document.createElement('div');
        this._container.className = `msb-container msb-${this._variant}`;

        // Primary button
        this._primaryBtn = document.createElement('button');
        this._primaryBtn.className = 'msb-primary';
        this._primaryBtn.type = 'button';

        // WCAG: Add accessible label to primary button
        const primaryLabel = this._ariaLabel || this._text;
        if (primaryLabel) {
          this._primaryBtn.setAttribute('aria-label', primaryLabel);
        }

        if (this._leadingIcon) {
          const iconEl = document.createElement('span');
          iconEl.className = 'msb-icon material-icons';
          iconEl.textContent = this._leadingIcon;
          this._primaryBtn.appendChild(iconEl);
        }

        const textEl = document.createElement('span');
        textEl.className = 'msb-text';
        textEl.textContent = this._text;
        this._primaryBtn.appendChild(textEl);

        if (!this._disableRipple) {
          const ripple = document.createElement('span');
          ripple.className = 'msb-ripple';
          this._primaryBtn.appendChild(ripple);
        }

        this._container.appendChild(this._primaryBtn);

        // Divider
        const divider = document.createElement('div');
        divider.className = 'msb-divider';
        this._container.appendChild(divider);

        // Dropdown button
        this._dropdownBtn = document.createElement('button');
        this._dropdownBtn.className = 'msb-dropdown';
        this._dropdownBtn.type = 'button';

        // WCAG: Add ARIA attributes for dropdown menu
        const dropdownLabel = this._dropdownAriaLabel || 'More options';
        this._dropdownBtn.setAttribute('aria-label', dropdownLabel);
        this._dropdownBtn.setAttribute('aria-haspopup', 'menu');
        this._dropdownBtn.setAttribute('aria-expanded', this._isOpen ? 'true' : 'false');

        const arrowEl = document.createElement('span');
        arrowEl.className = 'msb-arrow material-icons';
        arrowEl.textContent = 'arrow_drop_down';
        this._dropdownBtn.appendChild(arrowEl);

        if (!this._disableRipple) {
          const ripple = document.createElement('span');
          ripple.className = 'msb-ripple';
          this._dropdownBtn.appendChild(ripple);
        }

        this._container.appendChild(this._dropdownBtn);

        // Menu - create but don't append to container (will be portaled to body)
        this._menu = document.createElement('div');
        this._menu.className = 'msb-menu';
        this._buildMenuItems();
        // Menu will be portaled to body on first open for overlay behavior

        this.appendChild(this._container);
        this._updateState();
      }

      _buildMenuItems() {
        if (!this._menu) return;
        this._menu.innerHTML = '';

        this._parsedItems.forEach((item, index) => {
          const menuItem = document.createElement('div');
          menuItem.className = 'msb-menu-item';

          if (item.icon) {
            const iconEl = document.createElement('span');
            iconEl.className = 'msb-menu-icon material-icons';
            iconEl.textContent = item.icon;
            menuItem.appendChild(iconEl);
          }

          const labelEl = document.createElement('span');
          labelEl.className = 'msb-menu-text';
          labelEl.textContent = item.label;
          menuItem.appendChild(labelEl);

          menuItem.addEventListener('click', (e) => {
            e.stopPropagation();
            this._selectItem(item, index);
          });

          this._menu.appendChild(menuItem);
        });
      }

      _selectItem(item, index) {
        this.close();

        // Store the selected value
        this._selectedValue = item.label;
        safeRaisePropertyChanged(this, 'selectedValue');

        this.dispatchEvent(new CustomEvent('MenuItemClicked', {
          bubbles: true,
          detail: { icon: item.icon, label: item.label, index: index }
        }));
      }

      _applyStyles() {
        this.style.display = this._isVisible ? 'inline-block' : 'none';
        this.style.fontFamily = this._fontFamily;

        if (this._container) {
          this._container.style.setProperty('--msb-primary', this._primaryColor);
          this._container.style.setProperty('--msb-outline', this._outlineColor);
          this._container.style.setProperty('--msb-surface', this._surfaceColor);
          this._container.style.setProperty('--msb-surface-variant', this._surfaceVariantColor);
          this._container.style.setProperty('--msb-on-surface', this._menuTextColor);
          if (this._textColor) {
            this._container.style.setProperty('--msb-on-primary', this._textColor);
          }
          if (this._menuBackgroundColor) {
            this._container.style.setProperty('--msb-menu-bg', this._menuBackgroundColor);
          }
          if (this._dividerColor) {
            this._container.style.setProperty('--msb-divider-color', this._dividerColor);
          }
        }

        // Apply font styling to button text elements
        const textEl = this._primaryBtn?.querySelector('.msb-text');
        if (textEl) {
          textEl.style.fontSize = `${this._fontSize}px`;
          textEl.style.fontWeight = this._fontWeight;
          textEl.style.fontStyle = this._fontStyle;
        }

        // Apply font styling to menu items
        if (this._menu) {
          const menuTexts = this._menu.querySelectorAll('.msb-menu-text');
          menuTexts.forEach(menuText => {
            menuText.style.fontSize = `${this._fontSize}px`;
            menuText.style.fontWeight = this._fontWeight;
            menuText.style.fontStyle = this._fontStyle;
          });
        }
      }

      _bindEvents() {
        // Primary button click
        this._primaryBtn.addEventListener('click', (e) => {
          if (!this._isEnabled) return;

          if (!this._disableRipple) {
            this._createRipple(e, this._primaryBtn);
          }

          this.dispatchEvent(new CustomEvent('PrimaryClicked', {
            bubbles: true,
            detail: { text: this._text }
          }));
        });

        // Dropdown button click
        this._dropdownBtn.addEventListener('click', (e) => {
          if (!this._isEnabled) return;
          e.stopPropagation();

          if (!this._disableRipple) {
            this._createRipple(e, this._dropdownBtn);
          }

          if (this._isOpen) {
            this.close();
          } else {
            this.open();
          }
        });

        // WCAG: Keyboard navigation - Escape to close menu
        this._dropdownBtn.addEventListener('keydown', (e) => {
          if (!this._isEnabled) return;
          if (e.key === 'Escape' && this._isOpen) {
            e.preventDefault();
            this.close();
            this._dropdownBtn.focus(); // Return focus to dropdown button
          }
        });

        // Click outside to close
        document.addEventListener('click', this._handleClickOutside);
      }

      _handleClickOutside(e) {
        if (this._isOpen && !this.contains(e.target) && !this._menu.contains(e.target)) {
          this.close();
        }
      }

      _handleScroll() {
        if (this._isOpen) {
          this._positionMenu();
        }
      }

      _handleResize() {
        if (this._isOpen) {
          this._positionMenu();
        }
      }

      _positionMenu() {
        if (!this._menu || !this._dropdownBtn) return;

        const rect = this._dropdownBtn.getBoundingClientRect();
        const containerRect = this._container.getBoundingClientRect();
        const menuHeight = this._menu.scrollHeight || 200;
        const viewportHeight = window.innerHeight;

        // Calculate position - prefer below button, but flip above if not enough space
        let top = containerRect.bottom + 4;
        if (top + menuHeight > viewportHeight && containerRect.top > menuHeight) {
          top = containerRect.top - menuHeight - 4;
        }

        // Menu should align with left edge of the button container
        const left = containerRect.left;
        const minWidth = containerRect.width;

        this._menu.style.position = 'fixed';
        this._menu.style.top = `${top}px`;
        this._menu.style.left = `${left}px`;
        this._menu.style.minWidth = `${minWidth}px`;
        this._menu.style.zIndex = '2147483647';
      }

      _createRipple(event, button) {
        const rippleContainer = button.querySelector('.msb-ripple');
        if (!rippleContainer) return;

        const ripple = document.createElement('span');
        ripple.className = 'msb-ripple-effect';

        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);

        ripple.style.cssText = `
          width: ${size}px;
          height: ${size}px;
          left: ${event.clientX - rect.left - size / 2}px;
          top: ${event.clientY - rect.top - size / 2}px;
        `;

        rippleContainer.appendChild(ripple);
        ripple.addEventListener('animationend', () => ripple.remove());
      }

      _updateState() {
        if (!this._container) return;

        if (!this._isEnabled) {
          this._primaryBtn.disabled = true;
          this._dropdownBtn.disabled = true;
          this._container.classList.add('msb-disabled');
        } else {
          this._primaryBtn.disabled = false;
          this._dropdownBtn.disabled = false;
          this._container.classList.remove('msb-disabled');
        }

        this._container.classList.toggle('msb-open', this._isOpen);

        // Update ARIA expanded state
        this._dropdownBtn.setAttribute('aria-expanded', this._isOpen ? 'true' : 'false');

        // Rotate arrow
        const arrow = this._dropdownBtn.querySelector('.msb-arrow');
        if (arrow) {
          arrow.style.transform = this._isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        }
      }

      // Public methods
      open() {
        if (!this._isEnabled || this._isOpen) return;
        this._isOpen = true;

        // Portal menu to body for overlay behavior (prevents clipping)
        if (!this._menu.__portaled) {
          document.body.appendChild(this._menu);
          this._menu.__portaled = true;
        }

        // Apply menu styling
        this._menu.style.display = 'block';
        this._menu.style.backgroundColor = this._menuBackgroundColor || this._surfaceColor || '#FFFBFE';
        this._menu.style.color = this._menuTextColor || '#1C1B1F';
        this._menu.style.borderRadius = '4px';
        this._menu.style.boxShadow = '0 8px 12px rgba(0, 0, 0, 0.15), 0 4px 4px rgba(0, 0, 0, 0.3)';
        this._menu.style.overflow = 'hidden';
        this._menu.style.maxHeight = '300px';
        this._menu.style.overflowY = 'auto';

        this._positionMenu();
        this._updateState();

        // Add scroll/resize listeners
        window.addEventListener('scroll', this._handleScroll, true);
        window.addEventListener('resize', this._handleResize);
      }

      close() {
        if (!this._isOpen) return;
        this._isOpen = false;

        if (this._menu) {
          this._menu.style.display = 'none';
        }

        this._updateState();

        // Remove scroll/resize listeners
        window.removeEventListener('scroll', this._handleScroll, true);
        window.removeEventListener('resize', this._handleResize);
      }

      // Properties
      get text() { return this._text; }
      set text(v) {
        this._text = v || 'Save';
        if (this._hasRendered) {
          const textEl = this._primaryBtn?.querySelector('.msb-text');
          if (textEl) textEl.textContent = this._text;
        }
        safeRaisePropertyChanged(this, 'text');
      }
      get Text() { return this.text; }
      set Text(v) { this.text = v; }

      get selectedValue() { return this._selectedValue; }
      set selectedValue(v) {
        this._selectedValue = v || '';
        safeRaisePropertyChanged(this, 'selectedValue');
      }
      get SelectedValue() { return this.selectedValue; }
      set SelectedValue(v) { this.selectedValue = v; }

      get ariaLabel() { return this._ariaLabel; }
      set ariaLabel(v) {
        this._ariaLabel = v || '';
        if (this._primaryBtn) {
          const label = this._ariaLabel || this._text;
          this._primaryBtn.setAttribute('aria-label', label);
        }
        safeRaisePropertyChanged(this, 'ariaLabel');
      }
      get AriaLabel() { return this.ariaLabel; }
      set AriaLabel(v) { this.ariaLabel = v; }

      get dropdownAriaLabel() { return this._dropdownAriaLabel; }
      set dropdownAriaLabel(v) {
        this._dropdownAriaLabel = v || '';
        if (this._dropdownBtn) {
          const label = this._dropdownAriaLabel || 'More options';
          this._dropdownBtn.setAttribute('aria-label', label);
        }
        safeRaisePropertyChanged(this, 'dropdownAriaLabel');
      }
      get DropdownAriaLabel() { return this.dropdownAriaLabel; }
      set DropdownAriaLabel(v) { this.dropdownAriaLabel = v; }

      get leadingIcon() { return this._leadingIcon; }
      set leadingIcon(v) {
        this._leadingIcon = v || '';
        if (this._hasRendered) this._render();
        safeRaisePropertyChanged(this, 'leadingIcon');
      }
      get LeadingIcon() { return this.leadingIcon; }
      set LeadingIcon(v) { this.leadingIcon = v; }

      get variant() { return this._variant; }
      set variant(v) {
        const valid = ['filled', 'outlined', 'tonal'];
        this._variant = valid.includes(v) ? v : 'filled';
        if (this._hasRendered) this._render();
        safeRaisePropertyChanged(this, 'variant');
      }
      get Variant() { return this.variant; }
      set Variant(v) { this.variant = v; }

      get menuItems() { return this._menuItems; }
      set menuItems(v) {
        this._menuItems = v || '';
        this._parseMenuItems();
        if (this._hasRendered) this._buildMenuItems();
        safeRaisePropertyChanged(this, 'menuItems');
      }
      get MenuItems() { return this.menuItems; }
      set MenuItems(v) { this.menuItems = v; }

      get delimiter() { return this._delimiter; }
      set delimiter(v) {
        this._delimiter = v || '|';
        this._parseMenuItems();
        if (this._hasRendered) this._buildMenuItems();
        safeRaisePropertyChanged(this, 'delimiter');
      }
      get Delimiter() { return this.delimiter; }
      set Delimiter(v) { this.delimiter = v; }

      get primaryColor() { return this._primaryColor; }
      set primaryColor(v) {
        this._primaryColor = v || '#6750A4';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'primaryColor');
      }
      get PrimaryColor() { return this.primaryColor; }
      set PrimaryColor(v) { this.primaryColor = v; }

      get textColor() { return this._textColor; }
      set textColor(v) {
        this._textColor = v || '';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'textColor');
      }
      get TextColor() { return this.textColor; }
      set TextColor(v) { this.textColor = v; }

      get outlineColor() { return this._outlineColor; }
      set outlineColor(v) {
        this._outlineColor = v || '#79747E';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'outlineColor');
      }
      get OutlineColor() { return this.outlineColor; }
      set OutlineColor(v) { this.outlineColor = v; }

      get surfaceColor() { return this._surfaceColor; }
      set surfaceColor(v) {
        this._surfaceColor = v || '#FFFBFE';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'surfaceColor');
      }
      get SurfaceColor() { return this.surfaceColor; }
      set SurfaceColor(v) { this.surfaceColor = v; }

      get surfaceVariantColor() { return this._surfaceVariantColor; }
      set surfaceVariantColor(v) {
        this._surfaceVariantColor = v || '#E7E0EC';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'surfaceVariantColor');
      }
      get SurfaceVariantColor() { return this.surfaceVariantColor; }
      set SurfaceVariantColor(v) { this.surfaceVariantColor = v; }

      get menuBackgroundColor() { return this._menuBackgroundColor; }
      set menuBackgroundColor(v) {
        this._menuBackgroundColor = v || '';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'menuBackgroundColor');
      }
      get MenuBackgroundColor() { return this.menuBackgroundColor; }
      set MenuBackgroundColor(v) { this.menuBackgroundColor = v; }

      get menuTextColor() { return this._menuTextColor; }
      set menuTextColor(v) {
        this._menuTextColor = v || '#1C1B1F';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'menuTextColor');
      }
      get MenuTextColor() { return this.menuTextColor; }
      set MenuTextColor(v) { this.menuTextColor = v; }

      get dividerColor() { return this._dividerColor; }
      set dividerColor(v) {
        this._dividerColor = v || '';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'dividerColor');
      }
      get DividerColor() { return this.dividerColor; }
      set DividerColor(v) { this.dividerColor = v; }

      get disableRipple() { return this._disableRipple; }
      set disableRipple(v) {
        this._disableRipple = (v === true || v === 'true');
        if (this._hasRendered) this._render();
        safeRaisePropertyChanged(this, 'disableRipple');
      }
      get DisableRipple() { return this.disableRipple; }
      set DisableRipple(v) { this.disableRipple = v; }

      get fontFamily() { return this._fontFamily; }
      set fontFamily(v) {
        this._fontFamily = v || 'Roboto, sans-serif';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'fontFamily');
      }
      get FontFamily() { return this.fontFamily; }
      set FontFamily(v) { this.fontFamily = v; }

      get fontSize() { return this._fontSize; }
      set fontSize(v) {
        this._fontSize = v || 14;
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'fontSize');
      }
      get FontSize() { return this.fontSize; }
      set FontSize(v) { this.fontSize = v; }

      get fontWeight() { return this._fontWeight; }
      set fontWeight(v) {
        this._fontWeight = v || '500';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'fontWeight');
      }
      get FontWeight() { return this.fontWeight; }
      set FontWeight(v) { this.fontWeight = v; }

      get fontStyle() { return this._fontStyle; }
      set fontStyle(v) {
        this._fontStyle = v || 'normal';
        if (this._hasRendered) this._applyStyles();
        safeRaisePropertyChanged(this, 'fontStyle');
      }
      get FontStyle() { return this.fontStyle; }
      set FontStyle(v) { this.fontStyle = v; }

      get IsVisible() { return this._isVisible; }
      set IsVisible(val) {
        this._isVisible = (val === true || val === 'true');
        this.style.display = this._isVisible ? 'inline-block' : 'none';
      }

      get IsEnabled() { return this._isEnabled; }
      set IsEnabled(val) {
        this._isEnabled = (val === true || val === 'true');
        this._updateState();
      }
    });
  }
})();


}
